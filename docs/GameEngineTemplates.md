### **AI Dungeon Master 引擎核心设计演进**

#### **层次一：孤立节点模型**

* **核心思想**: 游戏由一系列独立的场景（节点）组成。在每个场景中，为玩家提供若干选项，玩家的选择会触发一段对应的描述文本。
* **实现方式**: 每个节点仅包含自身的描述和固定的选项文本。
* **局限性**: 节点之间没有依赖关系和状态记忆。玩家的选择无法影响后续的剧情走向，缺乏连贯的因果逻辑，体验较为割裂。

#### **层次二：结构化因果图模型**

* **核心思想**: 将游戏剧情组织为一张预设的、由节点和动作构成的因果图，以保证故事的逻辑性和一致性 。节点之间通过玩家执行的特定动作进行状态转移。
* **实现方式**: 通过 YAML 文件来定义整个剧情图谱 。
    * **节点 (Node)**: 代表一个游戏场景，包含场景描述、预设的关键动作等。
    * **动作 (Action)**: 定义了玩家可以执行并能推动剧情的关键行为。每个动作包含：
        * `keywords`: 用于匹配玩家的自然语言输入 。
        * `conditions`: 执行该动作所需满足的游戏状态（例如，`state.has_key == true`）。
        * 
        * 
        * `updates_state`: 成功执行后对游戏状态的修改（对应“JSON 状态持久化” ）。
        * `effects`: 动作的后果，主要是通过 `transition_to` 转移到下一个节点。
* **示例**:
    ```yaml
    # stories/haunted_mansion.yml
    initial_state:
      door_locked: true
      has_key: false
    nodes:
      - id: entry_hall
        description: "你站在一座古老庄园的门厅。北边有一扇紧闭的橡木门，门厅中央摆放着一张蒙着白布的桌子。"
        actions:
          - id: inspect_table
            keywords: ["调查桌子", "查看桌子"]
            narration: "你掀开白布，发现下面放着一把生锈的铜钥匙。"
            updates_state:
              has_key: true
          - id: use_key_on_door
            keywords: ["用钥匙开门", "使用钥匙"]
            conditions: ["state.has_key == true"]
            narration: "你将铜钥匙插入锁孔，轻轻一转，听到了‘咔哒’一声，锁开了。"
            updates_state:
              door_locked: false
          - id: go_to_corridor
            keywords: ["穿过门", "去北边"]
            conditions: ["state.door_locked == false"]
            narration: "你推开沉重的橡木门，走进了一条长长的、昏暗的走廊。"
            effects:
              - transition_to: "dim_corridor"
    
      - id: dim_corridor
        description: "你进入了一条昏暗的走廊。墙上的壁画在摇曳的烛光下显得格外诡异。走廊的尽头似乎有微弱的光亮。"
        actions:
          - id: inspect_murals
            keywords: ["观察壁画", "查看墙壁"]
            narration: "壁画上描绘着一个家族的兴衰史，最后一幅画上的人都指向了走廊的尽头。"
          - id: walk_to_end_of_corridor
            keywords: ["走向光亮", "走到走廊尽头"]
            narration: "你顺着走廊向前走，尽头的光亮越来越清晰，那似乎是一扇虚掩着的门。"
            effects:
              - transition_to: "alchemys_door"
    ```
* **局限性**: 玩家的所有有效行为都被严格限制在预设的 `actions` 列表中，缺乏探索的自由度。

#### **层次三：动态生成模型**

* **核心思想**: 允许玩家的输入实时地、动态地创建新的游戏内容（动作或节点），从而提供更高维度的自由度。该模型可进一步细分为“伪自由度”和“真自由度”两个阶段。

##### **3.1 伪自由度：基于LLM的创意叙事**

* **实现方式**: 此方案是结构化因果图的直接增强。
    1.  **关键动作匹配**: 引擎首先尝试将玩家的输入匹配到当前节点的预设“关键动作”上。
    2.  **创意动作处理**: 如果未能匹配，则将该输入视为“创意动作”。**叙事生成Agent** 会调用 LLM，根据当前场景和玩家的创意动作，生成一段生动有趣的叙事文本 。
* **示例**: 玩家在门厅输入“我把桌上的花瓶砸碎”，引擎会生成描述花瓶碎裂、巨响回荡的场景，但**不会对游戏的核心状态（`door_locked`, `has_key`）产生任何影响**。玩家在叙事结束后，仍停留在原节点。
* **局限性**: 玩家的创意无法真正改变游戏进程，是一种有边界的、被动的自由度。

##### **3.2 真自由度：动态世界模拟**

* **实现方式**: 这是对游戏引擎核心架构的深度改造，它允许玩家的创意真实地改变世界，甚至开辟全新的剧情线。这套方案可再细分为以下三个能力等级：

    * **3.2.1 动态状态修改 (Dynamic State Modification)**
        * **目标**: 允许未预设的动作改变游戏的核心状态。
        * **机制**: 引入“世界规则引擎”Agent。对于创意动作，该引擎会发起一次**逻辑判定**，并以结构化的形式（如JSON）返回判定结果。
        * **示例**: 玩家输入“在角落里找铁丝”。
            * **判定成功**: 引擎返回 `{"action_successful": true, "state_updates": {"inventory.has_wire": true}, "narration": "你在墙角的砖缝里找到了一小段旧铁丝。"}`。游戏主循环接收后，更新全局状态，并向玩家输出叙事。
            * **判定失败**: 引擎返回 `{"action_successful": false, ...}`，状态不发生变化。

    * **3.2.2 动态动作生成 (Dynamic Action Generation)**
        * **目标**: 基于动态变化后的新状态，实时生成合乎逻辑的新动作。
        * **机制**: 在每回合开始，“世界规则引擎”会进行一次“可能性推演”，扫描当前状态和场景，生成**“衍生动作”**。
        * **示例**: 当游戏状态变为 `{"inventory.has_wire": true}` 后，引擎会动态生成一个可被识别的新动作，如 `{"id": "emergent_pick_lock", "keywords": ["用铁丝撬锁"]}`。这使得玩家可以自然地利用他们的新发现。

    * **3.2.3 动态节点生成 (Dynamic Node Generation)**
        * **目标**: 在玩家行为彻底打破预设路径时，实时创造全新的游戏场景。
        * **机制**: 当一个创意动作的后果无法链接到任何现有节点时（如“炸开西墙”），会触发“世界创生”事件。一个更高阶的“世界生成 Agent”会根据世界观设定，实时生成一个包含完整描述和新动作的**全新节点数据**。
        * **示例**: AI根据“庄园西侧是炼金实验室”的设定，生成一个全新的“废弃的炼金实验室”节点，并动态地加入到游戏地图中，供玩家探索。